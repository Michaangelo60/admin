<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin - Xapo Bank</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0b1220;color:#e6eef8;padding:24px}
    .card{background:#071026;padding:18px;border-radius:8px;max-width:820px;margin:12px auto}
    input,button{font-size:14px;padding:8px;border-radius:6px;border:1px solid #234;color:#e6eef8;background:#052033}
    button{cursor:pointer}
    pre{background:#02131f;padding:12px;border-radius:6px;overflow:auto;color:#cfe7ff}
  </style>
</head>
<body>
  <main class="card">
    <h1 style="margin:0 0 12px">Admin Console</h1>
    <p style="margin:0 0 18px">Simple admin UI to call your deployed backend. Backend origin will default to <code>https://xa-poloan.onrender.com</code> unless `window.API_BASE` is set by `/config.js`.</p>

    <section id="auth" style="margin-bottom:14px">
      <h3 style="margin:0 0 8px">Sign in</h3>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <input id="email" placeholder="admin email" style="flex:1" value="" />
        <input id="password" type="password" placeholder="password" style="width:240px" />
        <button id="loginBtn">Sign in</button>
      </div>
      <div id="authMsg" style="color:#ffd;opacity:0.9"></div>
    </section>

    <section id="actions" style="display:none;margin-bottom:14px">
      <h3 style="margin:0 0 8px">Actions</h3>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <button id="listEmails">List saved emails (file backend)</button>
        <button id="health">Health</button>
        <button id="testEmail">Send test email (server)</button>
      </div>
      <div style="margin-bottom:8px">
        <label style="font-size:13px;opacity:0.85">Recipient for test email:</label>
        <input id="testTo" placeholder="you@example.com" style="width:320px;margin-left:8px" />
      </div>
    </section>

    <section>
      <h3 style="margin:0 0 8px">Response</h3>
      <pre id="out">Not connected.</pre>
    </section>
  </main>

  <script>
    const API_BASE = (window.API_BASE || window.ADMIN_API || 'https://xa-poloan.onrender.com').replace(/\/$/, '');
    const out = id => document.getElementById(id);
    const setOut = (v) => { out('out').textContent = typeof v === 'string' ? v : JSON.stringify(v, null, 2); };
    // show resolved API base for debugging
    setOut({ info: 'Using API_BASE', API_BASE });

    function authHeaders() {
      const t = localStorage.getItem('admin_token');
      return t ? { 'Authorization': 'Bearer ' + t } : {};
    }

    document.getElementById('loginBtn').addEventListener('click', async () => {
      const email = out('email').value.trim();
      const password = out('password').value;
      if (!email || !password) return setOut('Provide email and password');
      setOut('Signing in...');
      try {
        const url = API_BASE + '/api/auth/login';
        console.debug('Login request to', url);
        const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email, password }) });
        let data = null;
        let text = null;
        try {
          data = await res.json();
        } catch (e) {
          try { text = await res.text(); } catch (_) { text = null; }
        }
        if (res.ok) {
          const token = data && (data.token || data.token === 0 ? data.token : (data.data && data.data.token ? data.data.token : null));
          if (token) {
            localStorage.setItem('admin_token', token);
            out('authMsg').textContent = 'Signed in';
            document.getElementById('actions').style.display = 'block';
            setOut({ ok:true, message: 'Signed in' });
          } else {
            setOut({ ok:false, status: res.status, body: data || text || 'No token in response' });
          }
        } else {
          setOut({ ok:false, status: res.status, body: data || text });
        }
      } catch (err) {
        console.error('Login network error', err);
        setOut({ ok:false, error: String(err) });
      }
    });

    document.getElementById('health').addEventListener('click', async () => {
      setOut('Checking health...');
      try {
        const r = await fetch(API_BASE + '/api/health');
        const j = await r.json(); setOut(j);
      } catch (e) { setOut(String(e)); }
    });

    document.getElementById('listEmails').addEventListener('click', async () => {
      setOut('Fetching saved emails...');
      try {
        const r = await fetch(API_BASE + '/api/admin/emails?limit=20&content=true', { headers: authHeaders() });
        const j = await r.json(); setOut(j);
      } catch (e) { setOut(String(e)); }
    });

    document.getElementById('testEmail').addEventListener('click', async () => {
      const to = document.getElementById('testTo').value.trim();
      if (!to) return setOut('Set recipient first');
      setOut('Requesting test send...');
      try {
        const r = await fetch(API_BASE + '/api/test/email', { method:'POST', headers: Object.assign({'Content-Type':'application/json'}, authHeaders()), body: JSON.stringify({ to, subject:'Admin test', text:'Hello from admin UI' }) });
        const j = await r.json(); setOut(j);
      } catch (e) { setOut(String(e)); }
    });

    // show actions if already logged in
    if (localStorage.getItem('admin_token')) document.getElementById('actions').style.display = 'block';
  </script>
</body>
</html>
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Transaction Admin - Dashboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <main class="container">
    <h1>Pending Transactions</h1>
    <div id="user-info" class="muted"></div>
    <div id="controls">
      <button id="refresh-btn">Refresh</button>
      <button id="promote-btn">Promote to Admin (dev)</button>
      <button id="logout-btn">Logout</button>
    </div>
    <div id="tx-list">Loading...</div>
    <div id="status" class="muted"></div>
  </main>
    <script>
      // Ensure admin page points to backend API when served from a separate static host
      (function(){
        try {
          if (!window.API_BASE && !window.API_URL) {
            window.API_BASE = 'https://xa-poloan.onrender.com';
            window.API_URL = window.API_BASE;
          }
        } catch (e) {}
      })();
    </script>
    <script src="script.js"></script>
</body>
</html>
